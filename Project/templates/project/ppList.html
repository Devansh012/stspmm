{% extends "registration/base.html" %}
{% block content %}
    <h2>Project Proposal List for {{ projectLead.projectName }}</h2>

    <a href="{% url 'plList' %}" style="text-decoration: none;">
        <button type="button" class="btn btn-secondary btn-sm">
            <span style="font-size: 1.2em;">&#8592; Back</span>
        </button>
    </a>
    <a href="{% url 'ppCreateView' id %}">
        <button type="button" class="btn btn-primary btn-sm" style="float:right;">
            Add New
        </button>
    </a>

    <!-- Table displaying Project Proposals -->
    <table class="table mt-3" >
        <thead>
            <tr>
                <th>Submission Date</th>
                <th>Proposal Cost</th>
                <th>Accepted</th>
                <th>DCI</th>
                <th>Acceptance Date</th>
                <th>Work Order Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for pp in projectProposals %}
            <tr>
                <td>{{ pp.submissionDate }}</td>
                <td>{{ pp.proposalCost }}</td>
                <td>{{ pp.accepted }}</td>
                <td>{{ pp.docControlIndex }}</td>
                <td>{{ pp.acceptedDate }}</td>
                <td>{{ pp.workOrderNo }}</td>
                <td>
                    <a href="{% url 'ppUpdateView' pp.id %}" title="Edit"><i class="fas fa-edit"></i></a>
                    <form action="{% url 'ppDeleteView' pp.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" style="border:none; background:none; padding:0;" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                    <!-- Approve button if not accepted -->
                    {% if not pp.accepted %}
                        <button type="button" class="btn btn-primary btn-sm"
                                hx-get="{% url 'approveProposal' pp.id %}"
                                hx-target="#proposal-{{ pp.id }}"
                                hx-swap="outerHTML"
                                data-bs-toggle="modal"
                                data-bs-target="#approveModal-{{ pp.id }}">
                            Approve
                        </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modal structure for approving proposals -->
     {% csrf_token %}
    {% for pp in projectProposals %}
    <div class="modal fade" id="approveModal-{{ pp.id }}" tabindex="-1" aria-labelledby="approveModalLabel-{{ pp.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approveModalLabel-{{ pp.id }}">Approve Proposal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="approveForm-{{ pp.id }}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="approvalDate-{{ pp.id }}" class="form-label">Approval Date</label>
                            <input type="date" class="form-control" id="approvalDate-{{ pp.id }}" name="approvalDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="workOrderNo-{{ pp.id }}" class="form-label">Work Order No.</label>
                            <input type="text" class="form-control" id="workOrderNo-{{ pp.id }}" name="workOrderNo" required>
                        </div>
                        <div class="mb-3">
                            <label for="workOrderDate-{{ pp.id }}" class="form-label">Work Order Date</label>
                            <input type="date" class="form-control" id="workOrderDate-{{ pp.id }}" name="workOrderDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="workAmount-{{ pp.id }}" class="form-label">Work Amount</label>
                            <input type="number" class="form-control" id="workAmount-{{ pp.id }}" name="workAmount" required>
                        </div>
                        <button type="button" 
                                class="btn btn-primary"
                                hx-post="{% url 'approveProposal' pp.id %}" 
                                hx-target="#proposal-{{ pp.id }}" 
                                hx-include="#approveForm-{{ pp.id }}" 
                                hx-swap="outerHTML">
                            Submit
                        </button>
                    </form>
                    
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <script>
        document.addEventListener('htmx:afterSwap', (event) => {
            if (event.detail.target.id === 'approveModal') {
                let modal = new bootstrap.Modal(document.getElementById('approveModal'));
                modal.show();
            }
        });
    </script>
{% endblock %}

